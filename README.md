[![Build Status](https://travis-ci.com/Otus-DevOps-2019-08/agapov97_infra.svg?branch=master)](https://travis-ci.com/Otus-DevOps-2019-08/agapov97_infra)

# agapov97_infra
agapov97 Infra repository

## ДЗ 3

Поднято 2 сервера:
 - bastion - слушающий внешнюю сеть
 - someinternalhost - слушающий только внутреннюю сеть

На первом поднят VPN-сервер для возможности "напрямую" взаимодействовать из внешней сети со вторым

Для того, чтобы была возможность подключения при помощи команды `ssh someinternalhost`, предлагаю использовать файл hosts

Веб-интерфейс VPN-сервера с валидным сертификатом: https://35.205.237.167.xip.moss.sh

bastion_IP = 35.205.237.167
someinternalhost_IP = 10.132.0.3

## ДЗ 4

В ходе выполнения дз произошло знакомство с консольной утилитой gcloud, было поднято приложение reddit

testapp_IP = 35.205.50.190
testapp_port = 9292

Команда для создания ВМ с запуском скрипта автоинициализации:
`gcloud compute instances create reddit-app-autoinit  --boot-disk-size=10GB  --image-family ubuntu-1604-lts   --image-project=ubuntu-os-cloud   --machine-type=g1-small   --tags puma-server   --restart-on-failure --metadata-from-file startup-script=startup_script.sh`

Команда для создания правила браундмауэра:
`gcloud compute firewall-rules create default-puma-server --allow=tcp:9292 --target-tags=puma-server`


## ДЗ 5

В ходе выполнения дз произошло знакомство с утилитой для создания образов Packer.
Был создан образ с необходимыми для запуска приложения сервисами.
Был создан образ с приложением целиком.
Добавлена команда для создания инстанса из образа посредством gcloud CLI.


## ДЗ 6

В ходе выполнения дз произошло знакомство с утилитой Terraform.
C её помощью был развёрнут инстанс приложения и правило firewall.
В результате выполнения дополнительного задания была выявлена следующая проблема: при добавлении ssh ключа пользователя через веб-интерфейс, при дальнейшем применении конфигурации terraform'ом, все изменения затрутся.
Был создан балансировщик и вторая копия приложения. Копирование конфига приложения пахнет копипастой и каждое последующее именение числа инстансов будет неудобным и повлечёт за собой раздувание конфигурационного файла. Во избежание этого был установлен параметр числа инстансов.

## ДЗ 7

Было создано кастомное правило firewall для доступа по SSH.

Произошло знакомство с механизмом импорта текущего состояния инфраструктуры, созданного в обход terraform.

База данных была вынесена на отдельный инстанс, настроены правила firewall для взаимодействия приложения и БД.

Произошло знакомство с принципом зависимости ресурсов.

В ходе выполнения дз произошло разбиение конфигурации из предыдущего ДЗ на модули.

Инфраструктура была разделена на два окружение - stage и prod.

Хранение текущего состоянии было вынесено в Google Cloud Storage.

Было выявлено, что при попытки одновременно запустить apply из разных мест, один из клиентов получит отказ из-за блокировки.

Добавлены необходимые провиженеры для запуска приложения из коробки.

## ДЗ 8

В ходе выполнения ДЗ произошло знакомство с утилитой Ansible.

Создан inventory-файл для упрощения выполениния команд.

Общие для всех команд параметры были вынесены в конфигурационный файл.

Был создан базовый плейбук для клонирования репозитория. При наличии соответствующего репозитории в соответствующей директории, ничего не происходит. Однако, если его удалить, происходит клонирование.

Был создан простой python-скрипт для формирование динамического json-inventory. Проверить его работу можно вызвав Ansible с дополнительным параметром -i inventory.py


## ДЗ 9

В ходе выполнения ДЗ произошло знакомство с хендлерами и шаблонами для конфигурации в Ansible.

Произошло знакомство с разными подходами:
 - один плейбук - один сценарий
 - один плейбук - несколько сценариев
 - несколько плейбуков

Провиженинг packer-образов изменён на Ansible-плейбуки.


## ДЗ 10

В ходе выполнения ДЗ перенёс созданные плейбуки в раздельные роли.

Описал два окружения - stage и prod.

Использовал коммьюнити роль nginx.

Использовал Ansible Vault для хранения секретов.

В README добавлен бейдж, показывающий статус последнего билда.
